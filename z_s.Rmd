---
title: "zonal_stat"
author: "Lallu Nikerthil Prathapan"
date: "2/27/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Packages install
```{r}
install.packages("D:/EAGLE/Master_Thesis_Hannes/1/R/packages/exactextractr_0.10.0.tar.gz", repos = NULL, type = "source")
```


```{r}
# List of packages to install
#packages_to_install <- c("exactextracter")

# Install the packages
#install.packages(packages_to_install)
```
#Packages library

```{r}
library(sf)
library(ggplot2)
library(raster)
library(exactextractr)
library(terra)
library(dplyr)
library(gridExtra)
```


#Zonal statistics for each of the global EO population datasets

#Loading the data of camps

```{r}
url <- "data_camps/idp_camps_224.shp"
sf_data <- st_read(url) 
```
# 1. GHSL DATA
```{r}
ghsl_raster_path<-"D:/EAGLE/Master_Thesis_Hannes/1/ghsl_pop_2020_mollweid_100m/merged_ghsl.tif"
# Read the raster file into R
ghsl_raster <- raster(ghsl_raster_path)

```

```{r}
# Display information about the raster
print(ghsl_raster)
```
```{r}
# Plot the raster
plot(ghsl_raster)
```
#The extract function

```{r}
# function

# weighted sum per polygon (using the size of the pixel covered by the polygon "coverage_fraction")

extract_sum  <-  function(raster, polygon, field){

  polygon $id_tmp <- as.data.frame(polygon)[,field]

  v.exact <- exactextractr::exact_extract(raster, polygon, include_cols = 'id_tmp', max_cells_in_memory=3e+10)

  x <- do.call("rbind",v.exact)

  x[,"wrld_pp_ncn_n"] <- x[, "value"] * x$coverage_fraction

  x_sum <- x %>%

    dplyr::group_by(id_tmp)%>%

    dplyr::summarise_at("wrld_pp_ncn_n", sum, na.rm = TRUE)

polygon <- polygon %>%

    left_join(x_sum, by = "id_tmp")

  rm(x,v.exact,x_sum)

  return(polygon)

}
```


```{r}
# Data
sf_data <- st_read(url) 
polygon_camps <-sf_data

```


```{r}
raster_population <- rast('D:/EAGLE/Master_Thesis_Hannes/1/ghsl_pop_2020_mollweid_100m/merged_ghsl.tif')
```

```{r}
# Call function

polygon_camps <- extract_sum(raster_population, polygon_camps,"Name")

```


#Difference in the population
```{r}
# Assuming you have a column named "N_INDVID" in the polygon_camps data frame
# Adjust the column name if needed

# Subtract N_INDVID from ras_name
polygon_camps$ghsl_difference <- polygon_camps$N_INDVID - polygon_camps$ras_name

# View the resulting data frame with the new "difference" column
print(polygon_camps)

```
#Writing the output of the ghsl extract

```{r}

library(sf)

# Convert the data frame to an sf object
sf_polygon_camps <- st_as_sf(polygon_camps)

# Remove Z (3D) coordinates
sf_polygon_camps <- st_zm(sf_polygon_camps, drop = TRUE)

# Export the sf object to a shapefile
st_write(sf_polygon_camps,
 "ghsl_output/polygon_camps_justghsl.shp")

```
GHSL some plot visualisation

```{r}
library(ggplot2)

# Assuming you have a column named "ras_name" in the polygon_camps data frame
# Change the column name if you used a different name in the code

# Define the ggplot object
ggplot(polygon_camps, aes(fill = ras_name)) +
  geom_sf() +  # Plot the polygons
  scale_fill_viridis_c() +  # Choose a color scale (you can change to your preference)
  labs(title = "Zonal Statistics of GHSL Values for Camps") +
  theme_minimal()

```
```{r}
# Scatter plot with site_status
ggplot(polygon_camps, aes(x = ras_name, y = N_INDVID, color = Site_Statu)) +
  geom_point() +
  labs(title = "Comparison between estimated and survey iom populations",
       x = "Estimated population",
       y = "Iom surveyed population") +
  theme_minimal()
```
```{r}
# Scatter plot with different colors based on Shelt_type
ggplot(polygon_camps, aes(x = ras_name, y = N_INDVID, color = Shelt_type)) +
  geom_point() +
  labs(title = "Comparison between ras_name and N_INDVID",
       x = "ras_name",
       y = "N_INDVID") +
  theme_minimal()
```

```{r}
# Scatter plot comparing N_INDIVID and N_HH
plot1 <- ggplot(polygon_camps, aes(x = N_INDVID, y = N_HH, color = ras_name)) +
  geom_point() +
  labs(title = "Comparison between N_INDVID and N_HH",
       x = "N_INDVID",
       y = "N_HH") +
  theme_minimal()

# Scatter plot comparing N_INDIVID and ras_name
plot2 <- ggplot(polygon_camps, aes(x = N_INDVID, y = ras_name, color = ras_name)) +
  geom_point() +
  labs(title = "Comparison between N_INDVID and ras_name",
       x = "N_INDVID",
       y = "ras_name") +
  theme_minimal()

# Scatter plot comparing N_HH and ras_name
plot3 <- ggplot(polygon_camps, aes(x = N_HH, y = ras_name, color = ras_name)) +
  geom_point() +
  labs(title = "Comparison between N_HH and ras_name",
       x = "N_HH",
       y = "ras_name") +
  theme_minimal()

# Arrange the plots in a grid
grid.arrange(plot1, plot2, plot3, ncol = 2)
```
#2.World POP(constrained)

```{r}
World_pop <- rast('D:/EAGLE/Master_Thesis_Hannes/1/world_pop/nga_ppp_2020.tif')
print(World_pop)
```


```{r}

# Call function

polygon_camps <- extract_sum(World_pop,polygon_camps,"Name")

```
#Difference in the survery_population and world_pop
```{r}
# Assuming you have a column named "N_INDVID" in the polygon_camps data frame
# Adjust the column name if needed

# Subtract N_INDVID from ras_name
polygon_camps$world_pop_difference <- polygon_camps$N_INDVID - polygon_camps$ras_name.x

# View the resulting data frame with the new "difference" column
print(polygon_camps)

```



#Writing the output of the worldpop unconstrained extract

```{r}
# Convert the data frame to an sf object
sf_polygon_camps2 <- st_as_sf(polygon_camps)

# Remove Z (3D) coordinates
sf_polygon_camps2 <- st_zm(sf_polygon_camps2, drop = TRUE)

# Export the sf object to a shapefile
st_write(sf_polygon_camps2,
 "world_pop_output/polygon_camps_2.shp")

```

#World pop constrained plots
```{r}
# Define the ggplot object
ggplot(polygon_camps, aes(fill = ras_name.y)) +
  geom_sf() +  # Plot the polygons
  scale_fill_viridis_c() +  # Choose a color scale (you can change to your preference)
  labs(title = "Zonal Statistics of GHSL Values for Camps") +
  theme_minimal()

```

```{r}
# Scatter plot with site_status
ggplot(polygon_camps, aes(x = ras_name.y, y = N_INDVID, color = Site_Statu)) +
  geom_point() +
  labs(title = "Comparison between estimated_worldpop and survey iom populations",
       x = "Estimated population_worldpop",
       y = "Iom surveyed population") +
  theme_minimal()
```





#3.World POP(unconstrained)
```{r}
World_pop_unconstr <- rast('D:/EAGLE/Master_Thesis_Hannes/1/world_pop_build/nga_ppp_2020_constrained.tif')
print(World_pop_unconstr)

```

```{r}
# Call function

polygon_camps <- extract_sum(World_pop_unconstr,polygon_camps,"Name")

```

#Difference in the survery_population and world_pop unconstrained
```{r}
# Assuming you have a column named "N_INDVID" in the polygon_camps data frame
# Adjust the column name if needed

# Subtract N_INDVID from ras_name
polygon_camps$wppu_diff <- polygon_camps$N_INDVID - polygon_camps$wrld_pp_ncn_n

# View the resulting data frame with the new "difference" column
print(polygon_camps)
```



#Writing the output of the worldpop unconstrained extract

```{r}
# Convert the data frame to an sf object
poly_camp3<- st_as_sf(polygon_camps)

# Remove Z (3D) coordinates
poly_camp3 <- st_zm(poly_camp3, drop = TRUE)

# Export the sf object to a shapefile
st_write(poly_camp3,
 "world_pop_uncons_output/polygon_wpun.shp")



```
#World pop unconstrained plots

```{r}
# Define the ggplot object
ggplot(polygon_camps, aes(fill = wrld_pp_ncn_n)) +
  geom_sf() +  # Plot the polygons
  scale_fill_viridis_c() +  # Choose a color scale (you can change to your preference)
  labs(title = "Zonal Statistics of worldpop constrained Values for Camps") +
  theme_minimal()
```

```{r}
# Scatter plot with site_status
ggplot(polygon_camps, aes(x = wrld_pp_ncn_n, y = N_INDVID, color = Site_Statu)) +
  geom_point() +
  labs(title = "Comparison between estimated_worldpop_unconstrained and survey iom populations",
       x = "Estimated population_worldpop_unconstrained",
       y = "Iom surveyed population") +
  theme_minimal()
```

#4. GPW_V4

```{r}

gpw <- rast('D:/EAGLE/Master_Thesis_Hannes/1/gpw/gpw-v4-population-count-rev11_2020_30_sec_tif/gpw_v4_population_count_rev11_2020_30_sec.tif')
print(gpw)
```
```{r}
# Call function

polygon_camps <- extract_sum(gpw,polygon_camps,"Name")
```
#Difference in the survery_population and gpw_population
```{r}
# Assuming you have a column named "N_INDVID" in the polygon_camps data frame
# Adjust the column name if needed

# Subtract N_INDVID from ras_name
polygon_camps$gpw_difference <- polygon_camps$N_INDVID - polygon_camps$gpw

# View the resulting data frame with the new "difference" column
print(polygon_camps)
```


#Writing the output of the gpw

```{r}
# Convert the data frame to an sf object
poly_camp4<- st_as_sf(polygon_camps)

# Remove Z (3D) coordinates
poly_camp4 <- st_zm(poly_camp4, drop = TRUE)

# Export the sf object to a shapefile
st_write(poly_camp4,
 "gpw/polygon_gpw.shp")



```
#Gpw plots

```{r}
# Define the ggplot object
ggplot(polygon_camps, aes(fill = wrld_pp_ncn_n)) +
  geom_sf() +  # Plot the polygons
  scale_fill_viridis_c() +  # Choose a color scale (you can change to your preference)
  labs(title = "Zonal Statistics of worldpop constrained Values for Camps") +
  theme_minimal()
```

```{r}
# Scatter plot with site_status
ggplot(polygon_camps, aes(x = gpw, y = N_INDVID, color = Site_Statu)) +
  geom_point() +
  labs(title = "Comparison between estimated_gpw and survey iom populations",
       x = "Estimated population_gpw",
       y = "Iom surveyed population") +
  theme_minimal()
```



#Removing unnecessary attributes// only run if needed
```{r}
attributes_to_remove <- c("wrld_pp_un_diff")

# Remove specified attributes
polygon_camps <- polygon_camps %>%
  select(-one_of(attributes_to_remove))
```

